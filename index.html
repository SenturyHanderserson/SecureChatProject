<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-bg {
            background: linear-gradient(-45deg, #0f0f0f, #1a2e1a, #0f0f0f, #1a2e1a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        
        .message-enter {
            animation: messageEnter 0.3s ease-out;
        }
        
        @keyframes messageEnter {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .channel-hover:hover {
            background-color: rgba(46, 204, 113, 0.1);
            transform: translateX(5px);
            transition: all 0.2s ease;
        }
        
        .role-admin { color: #e74c3c; }
        .role-moderator { color: #3498db; }
        .role-member { color: #2ecc71; }
        .role-guest { color: #95a5a6; }
        
        .pinned-message {
            border-left: 3px solid #f1c40f;
            background-color: rgba(241, 196, 15, 0.05);
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: #0f0f0f;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background-color: #2ecc71;
            border-radius: 6px;
        }
        
        .modal {
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    
    @keyframes progress {
        0% { width: 70%; }
        100% { width: 75%; }
    }
    
    .animate-progress {
        animation: progress 2s ease-in-out infinite alternate;
    }
    
    /* Loading dots animation */
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .bounce-1 { animation: bounce 0.6s infinite ease-in-out; }
    .bounce-2 { animation: bounce 0.6s infinite ease-in-out 0.2s; }
    .bounce-3 { animation: bounce 0.6s infinite ease-in-out 0.4s; }
    
    /* Signing in notification */
    .signing-in-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(46, 204, 113, 0.3);
        border: 1px solid #2ecc71;
    }
    
    .signing-in-text {
        margin-bottom: 15px;
        font-size: 18px;
        color: #2ecc71;
    }
    
    .loading-dots {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }
    
    .dot {
        width: 12px;
        height: 12px;
        background-color: #2ecc71;
        border-radius: 50%;
    }
    
    /* Development Notification Styles */
    @keyframes slideIn {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
    }
    
    .notification {
        animation: slideIn 0.5s ease-out forwards;
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    .close-btn:hover {
        transform: rotate(90deg);
        transition: transform 0.3s ease;
    }
    
    .leaf {
        position: absolute;
        width: 20px;
        height: 20px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50% 0 50% 50%;
        transform: rotate(-45deg);
    }
    
    .leaf-1 {
        top: 10px;
        left: 10px;
        animation: float 4s ease-in-out infinite;
    }
    
    .leaf-2 {
        bottom: 15px;
        right: 15px;
        animation: float 3s ease-in-out infinite reverse;
    }
    
    @keyframes float {
        0% { transform: translateY(0) rotate(-45deg); }
        50% { transform: translateY(-10px) rotate(-45deg); }
        100% { transform: translateY(0) rotate(-45deg); }
    }

    /* Loading more messages indicator */
    .loading-more {
        text-align: center;
        padding: 1rem;
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    /* New message notification */
    .new-message-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: rgba(46, 204, 113, 0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        z-index: 100;
        display: flex;
        align-items: center;
        animation: slideIn 0.3s ease-out;
    }
    
    .new-message-notification:hover {
        background-color: rgba(46, 204, 113, 1);
    }
    
    .new-message-notification i {
        margin-right: 8px;
    }
    </style>
</head>
<body class="gradient-bg text-white min-h-screen flex overflow-hidden">
    <!-- Signing In Notification -->
    <div id="signingInNotification" class="signing-in-notification hidden">
        <div class="signing-in-text">Signing you in...</div>
        <div class="loading-dots">
            <div class="dot bounce-1"></div>
            <div class="dot bounce-2"></div>
            <div class="dot bounce-3"></div>
        </div>
    </div>

    <!-- New Message Notification -->
    <div id="newMessageNotification" class="new-message-notification hidden">
        <i class="fas fa-comment-alt"></i>
        <span id="newMessageText">New messages</span>
    </div>

    <!-- Login/Signup Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="modal bg-gray-900 rounded-lg p-8 w-full max-w-md border border-green-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-green-400" id="authTitle">Login</h2>
                <button id="toggleAuth" class="text-green-400 hover:text-green-300">Switch to Signup</button>
            </div>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginUsername" class="block text-gray-300 mb-2">Username</label>
                    <input type="text" id="loginUsername" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-green-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-gray-300 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-green-500 focus:outline-none" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded transition duration-300">Login</button>
            </form>
            
            <form id="signupForm" class="hidden">
                <div class="mb-4">
                    <label for="signupUsername" class="block text-gray-300 mb-2">Username</label>
                    <input type="text" id="signupUsername" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-green-500 focus:outline-none" required>
                </div>
                <div class="mb-4">
                    <label for="signupEmail" class="block text-gray-300 mb-2">Email</label>
                    <input type="email" id="signupEmail" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-green-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label for="signupPassword" class="block text-gray-300 mb-2">Password</label>
                    <input type="password" id="signupPassword" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-green-500 focus:outline-none" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded transition duration-300">Sign Up</button>
            </form>
            
            <div id="authError" class="mt-4 text-red-400 hidden"></div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="appContainer" class="hidden w-full flex">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col h-screen">
            <div class="p-4 border-b border-gray-800 flex items-center">
                <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center mr-3">
                    <i class="fas fa-code text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-green-400">Secure Chat</h1>
            </div>
            
            <div class="flex-1 overflow-y-auto sidebar">
                <!-- Server Channels -->
                <div class="p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-400 uppercase text-xs font-bold">Channels</h3>
                        <button id="createChannelBtn" class="text-gray-400 hover:text-green-400" title="Create Channel">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <ul id="channelList">
                        <!-- Channels will be populated here -->
                    </ul>
                </div>
                
                <!-- Online Users -->
                <div class="p-4 border-t border-gray-800">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-400 uppercase text-xs font-bold">Online Members</h3>
                        <span id="onlineCount" class="text-gray-400">0</span>
                    </div>
                    
                    <ul id="userList">
                        <!-- Users will be populated here -->
                    </ul>
                </div>
            </div>
            
            <!-- User Profile -->
            <div class="p-4 border-t border-gray-800 bg-gray-900">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <div class="flex-1">
                        <div id="currentUsername" class="font-medium text-green-400">Guest</div>
                        <div id="currentUserRole" class="text-xs text-gray-400">Not logged in</div>
                    </div>
                    <button id="logoutBtn" class="text-gray-400 hover:text-green-400" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col h-screen">
            <!-- Channel Header -->
            <div class="p-4 border-b border-gray-800 bg-gray-900 flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-hashtag text-gray-500 mr-2"></i>
                    <h2 id="currentChannel" class="text-xl font-bold text-green-400">general</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="pinnedMessagesBtn" class="text-gray-400 hover:text-green-400" title="Pinned Messages">
                        <i class="fas fa-thumbtack"></i>
                    </button>
                    <button id="membersBtn" class="text-gray-400 hover:text-green-400" title="Members">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 bg-gray-900">
                <div class="max-w-3xl mx-auto">
                    <!-- Welcome Message -->
                    <div class="message-enter mb-8 text-center">
                        <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4 border-2 border-green-600">
                            <i class="fas fa-code text-3xl text-green-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-green-400 mb-2">Welcome to Secure Chat!</h3>
                        <p class="text-gray-400">This is the start of the <span class="text-green-400">#general</span> channel.</p>
                    </div>
                    
                    <!-- Messages will be loaded here -->
                    <div id="messageList">
                        <!-- Messages will be populated here -->
                    </div>
                    <div id="loadingMore" class="loading-more hidden">
                        Loading more messages...
                    </div>
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="p-4 border-t border-gray-800 bg-gray-900">
                <div class="max-w-3xl mx-auto">
                    <div id="replyIndicator" class="hidden mb-2 bg-gray-800 p-2 rounded text-sm text-gray-400">
                        <div class="flex justify-between items-center">
                            <span>Replying to <span id="replyToUser" class="text-green-400">User</span></span>
                            <button id="cancelReply" class="text-gray-500 hover:text-gray-300">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p id="replyPreview" class="truncate text-xs mt-1">Message preview...</p>
                    </div>
                    
                    <div class="relative">
                        <textarea id="messageInput" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-green-500 focus:outline-none resize-none" rows="1" placeholder="Message #general" disabled></textarea>
                        <div class="absolute right-3 bottom-3 flex items-center space-x-2">
                            <button class="text-gray-400 hover:text-green-400" title="Attach File">
                                <i class="fas fa-paperclip"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar (Members) -->
        <div id="membersSidebar" class="w-60 bg-gray-900 border-l border-gray-800 hidden">
            <div class="p-4 border-b border-gray-800">
                <div class="flex items-center justify-between">
                    <h3 class="font-bold text-green-400">Members</h3>
                    <button id="closeMembersBtn" class="text-gray-400 hover:text-green-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <input type="text" placeholder="Search members" class="w-full mt-3 bg-gray-800 border border-gray-700 rounded px-3 py-1 text-sm text-white focus:border-green-500 focus:outline-none">
            </div>
            
            <div class="p-2 overflow-y-auto h-full">
                <div class="mb-4">
                    <h4 class="text-xs text-gray-400 uppercase font-bold mb-2 px-2">Online — <span id="onlineCountSidebar">0</span></h4>
                    <ul id="onlineMembersList">
                        <!-- Online members will be populated here -->
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-xs text-gray-400 uppercase font-bold mb-2 px-2">Offline — <span id="offlineCountSidebar">0</span></h4>
                    <ul id="offlineMembersList">
                        <!-- Offline members will be populated here -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Pinned Messages Modal -->
        <div id="pinnedMessagesModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
            <div class="modal bg-gray-900 rounded-lg p-6 w-full max-w-2xl h-3/4 border border-green-700 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-green-400">Pinned Messages</h3>
                    <button id="closePinnedModal" class="text-gray-400 hover:text-green-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="pinnedMessagesList" class="flex-1 overflow-y-auto">
                    <!-- Pinned messages will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Create Channel Modal -->
        <div id="createChannelModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
            <div class="modal bg-gray-900 rounded-lg p-6 w-full max-w-md border border-green-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-green-400">Create Channel</h3>
                    <button id="closeCreateChannelModal" class="text-gray-400 hover:text-green-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="createChannelForm">
                    <div class="mb-4">
                        <label for="channelName" class="block text-gray-300 mb-2">Channel Name</label>
                        <div class="flex">
                            <span class="flex items-center bg-gray-800 border border-r-0 border-gray-700 rounded-l px-3 text-gray-400">#</span>
                            <input type="text" id="channelName" class="flex-1 bg-gray-800 border border-gray-700 rounded-r px-4 py-2 text-white focus:border-green-500 focus:outline-none" required>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="channelDescription" class="block text-gray-300 mb-2">Description (optional)</label>
                        <textarea id="channelDescription" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-green-500 focus:outline-none" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded transition duration-300">Create Channel</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://secure-chat-website-https-converter.onrender.com/api';
        
        // Current user state
        let currentUser = {
            username: null,
            role: 'guest',
            token: null
        };
        
        let currentChannel = 'general';
        let replyToMessage = null;
        let lastMessageTime = 0;
        let channelTotal = 0;
        let channelOffset = 0;
        let channelLoading = false;
        const PAGE_SIZE = 50;
        let messagePollingInterval;
        let lastMessageId = null;
        let isScrolledToBottom = true;
        let unreadMessages = {};
        let refreshInterval = null;
        
        // User roles and their display properties with fallback
        const roles = {
            admin: { name: 'Admin', color: 'role-admin' },
            moderator: { name: 'Moderator', color: 'role-moderator' },
            member: { name: 'Member', color: 'role-member' },
            guest: { name: 'Guest', color: 'role-guest' },
            default: { name: 'User', color: 'text-gray-400' } // Fallback for unknown roles
        };

        // Helper function to safely get role properties
        function getRoleInfo(role) {
            return roles[role] || roles.default;
        }
        
        // DOM Elements
        const authModal = document.getElementById('authModal');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const toggleAuth = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        const authError = document.getElementById('authError');
        const currentUsername = document.getElementById('currentUsername');
        const currentUserRole = document.getElementById('currentUserRole');
        const logoutBtn = document.getElementById('logoutBtn');
        const messageInput = document.getElementById('messageInput');
        const messageList = document.getElementById('messageList');
        const messagesContainer = document.getElementById('messagesContainer');
        const loadingMore = document.getElementById('loadingMore');
        const channelList = document.getElementById('channelList');
        const userList = document.getElementById('userList');
        const onlineCount = document.getElementById('onlineCount');
        const currentChannelDisplay = document.getElementById('currentChannel');
        const membersSidebar = document.getElementById('membersSidebar');
        const membersBtn = document.getElementById('membersBtn');
        const closeMembersBtn = document.getElementById('closeMembersBtn');
        const pinnedMessagesBtn = document.getElementById('pinnedMessagesBtn');
        const pinnedMessagesModal = document.getElementById('pinnedMessagesModal');
        const closePinnedModal = document.getElementById('closePinnedModal');
        const replyIndicator = document.getElementById('replyIndicator');
        const replyToUser = document.getElementById('replyToUser');
        const replyPreview = document.getElementById('replyPreview');
        const cancelReply = document.getElementById('cancelReply');
        const createChannelBtn = document.getElementById('createChannelBtn');
        const createChannelModal = document.getElementById('createChannelModal');
        const closeCreateChannelModal = document.getElementById('closeCreateChannelModal');
        const createChannelForm = document.getElementById('createChannelForm');
        const signingInNotification = document.getElementById('signingInNotification');
        const newMessageNotification = document.getElementById('newMessageNotification');
        const newMessageText = document.getElementById('newMessageText');
        
        // Event Listeners
        toggleAuth.addEventListener('click', toggleAuthForms);
        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignup);
        logoutBtn.addEventListener('click', handleLogout);
        messageInput.addEventListener('keydown', handleMessageInput);
        membersBtn.addEventListener('click', toggleMembersSidebar);
        closeMembersBtn.addEventListener('click', toggleMembersSidebar);
        pinnedMessagesBtn.addEventListener('click', showPinnedMessages);
        closePinnedModal.addEventListener('click', hidePinnedMessages);
        cancelReply.addEventListener('click', cancelMessageReply);
        createChannelBtn.addEventListener('click', showCreateChannelModal);
        closeCreateChannelModal.addEventListener('click', hideCreateChannelModal);
        createChannelForm.addEventListener('submit', handleCreateChannel);
        messagesContainer.addEventListener('scroll', handleScroll);
        newMessageNotification.addEventListener('click', scrollToBottom);
        
        // Initialize the app
        initApp();
        
        function initApp() {
            // Check for existing session
            checkAutoLogin();
            
            // Set up periodic updates
            setInterval(loadUsers, 30000); // Update users every 30 seconds
        }
        
        async function checkAutoLogin() {
            try {
                signingInNotification.classList.remove('hidden');
                
                const response = await fetch(`${API_BASE}/verify-token`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = {
                        username: data.username,
                        role: data.role,
                        token: data.token || null
                    };
                    
                    successfulLogin();
                } else {
                    // If verification fails, clear any invalid token
                    document.cookie = 'wb_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                }
            } catch (error) {
                console.error('Auto-login error:', error);
            } finally {
                signingInNotification.classList.add('hidden');
            }
        }
        
        function toggleAuthForms(e) {
            e.preventDefault();
            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                authTitle.textContent = 'Login';
                toggleAuth.textContent = 'Switch to Signup';
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                authTitle.textContent = 'Sign Up';
                toggleAuth.textContent = 'Switch to Login';
            }
            authError.classList.add('hidden');
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showAuthError('Please enter both username and password');
                return;
            }
            
            try {
                signingInNotification.classList.remove('hidden');
                
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Login failed');
                }
                
                const data = await response.json();
                currentUser = {
                    username: data.username,
                    role: data.role,
                    token: data.token || null
                };
                
                successfulLogin();
            } catch (error) {
                showAuthError(error.message);
            } finally {
                signingInNotification.classList.add('hidden');
            }
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            
            if (!username || !email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }
            
            try {
                signingInNotification.classList.remove('hidden');
                
                const response = await fetch(`${API_BASE}/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, email, password })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Signup failed');
                }
                
                const data = await response.json();
                currentUser = {
                    username: data.username,
                    role: data.role,
                    token: data.token || null
                };
                
                successfulLogin();
            } catch (error) {
                showAuthError(error.message);
            } finally {
                signingInNotification.classList.add('hidden');
            }
        }
        
        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }
        
        function successfulLogin() {
            authModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            updateUserDisplay();
            loadChannels();
            loadUsers();
            loadMessagesForChannel();
            messageInput.disabled = false;
            
            // Start polling for new messages
            startMessagePolling();
            
            // Clear forms
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('signupUsername').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            authError.classList.add('hidden');
        }
        
        function startMessagePolling() {
            // Clear any existing interval
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
            }
            
            // Start polling for new messages every 3 seconds
            messagePollingInterval = setInterval(checkForNewMessages, 3000);
        }
        
        async function checkForNewMessages() {
            try {
                // Only check if we have a last message ID to compare against
                if (lastMessageId) {
                    const response = await fetch(`${API_BASE}/messages/new?channel=${encodeURIComponent(currentChannel)}&lastId=${lastMessageId}`, {
                        credentials: 'include'
                    });
                    
                    if (!response.ok) throw new Error('Failed to check for new messages');
                    
                    const data = await response.json();
                    
                    if (data.messages && data.messages.length > 0) {
                        // Update last message ID
                        lastMessageId = data.messages[data.messages.length - 1].id;
                        
                        // Check if user is scrolled to bottom
                        const isAtBottom = isScrollAtBottom();
                        
                        // Add new messages to chat
                        data.messages.forEach(msg => {
                            addMessageToChat(msg.username, msg.role, formatTime(msg.timestamp), msg.content, msg.pinned, msg.id);
                        });
                        
                        // If not at bottom, show notification
                        if (!isAtBottom) {
                            showNewMessageNotification(data.messages.length);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking for new messages:', error);
            }
        }
        
        function isScrollAtBottom() {
            const container = messagesContainer;
            return container.scrollHeight - container.scrollTop - container.clientHeight < 50;
        }
        
        function showNewMessageNotification(count) {
            newMessageText.textContent = count === 1 ? '1 new message' : `${count} new messages`;
            newMessageNotification.classList.remove('hidden');
            
            // Hide after 5 seconds if not clicked
            setTimeout(() => {
                if (!newMessageNotification.classList.contains('hidden')) {
                    newMessageNotification.classList.add('hidden');
                }
            }, 5000);
        }
        
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            newMessageNotification.classList.add('hidden');
        }
        
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                currentUser = {
                    username: null,
                    role: 'guest',
                    token: null
                };
                
                // Clear polling interval
                if (messagePollingInterval) {
                    clearInterval(messagePollingInterval);
                    messagePollingInterval = null;
                }
                
                // Clear refresh interval
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                
                appContainer.classList.add('hidden');
                authModal.classList.remove('hidden');
                messageList.innerHTML = '';
                channelList.innerHTML = '';
                userList.innerHTML = '';
                messageInput.disabled = true;
                
                // Clear the token cookie
                document.cookie = 'wb_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            }
        }
        
        function updateUserDisplay() {
            if (currentUser.username) {
                currentUsername.textContent = currentUser.username;
                const roleInfo = getRoleInfo(currentUser.role);
                currentUsername.className = 'font-medium ' + roleInfo.color;
                currentUserRole.textContent = roleInfo.name;
            } else {
                currentUsername.textContent = 'Guest';
                currentUsername.className = 'font-medium text-gray-400';
                currentUserRole.textContent = 'Not logged in';
            }
        }
        
        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/channels`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load channels');
                
                const channels = await response.json();
                channelList.innerHTML = '';
                
                channels.forEach(channel => {
                    const channelItem = document.createElement('li');
                    channelItem.className = 'channel-item mb-1';
                    channelItem.dataset.channel = channel.name;
                    
                    const channelLink = document.createElement('a');
                    channelLink.href = '#';
                    channelLink.className = 'flex items-center py-1 px-2 rounded channel-hover text-gray-300 hover:text-white';
                    
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-hashtag mr-2 text-gray-500';
                    
                    const channelName = document.createElement('span');
                    channelName.textContent = channel.name;
                    
                    channelLink.appendChild(icon);
                    channelLink.appendChild(channelName);
                    channelItem.appendChild(channelLink);
                    channelList.appendChild(channelItem);
                    
                    channelLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        onChannelChange(channel.name);
                    });
                });
                
                highlightCurrentChannel();
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }
        
        function highlightCurrentChannel() {
            const channels = document.querySelectorAll('.channel-item');
            channels.forEach(channel => {
                if (channel.dataset.channel === currentChannel) {
                    channel.querySelector('a').classList.add('bg-gray-800', 'text-white');
                } else {
                    channel.querySelector('a').classList.remove('bg-gray-800', 'text-white');
                }
            });
        }
        
        function startChannelAutoRefresh() {
            // Clear any previous refresh timers
            if (refreshInterval) clearInterval(refreshInterval);

            // Refresh the current channel every 5 seconds
            refreshInterval = setInterval(async () => {
                try {
                    const response = await fetch(
                        `${API_BASE}/messages?channel=${encodeURIComponent(currentChannel)}&offset=${Math.max(0, channelTotal - PAGE_SIZE)}&limit=${PAGE_SIZE}`,
                        { credentials: 'include' }
                    );
                    if (!response.ok) return;

                    const data = await response.json();

                    // Compare newest message ID with the latest in the DOM
                    const latestInDOM = messageList.lastElementChild?.dataset.messageId;
                    const latestFromServer = data.messages[data.messages.length - 1]?.id;

                    if (latestFromServer && latestFromServer !== latestInDOM) {
                        // Append only new messages
                        const domIds = Array.from(messageList.children).map(el => el.dataset.messageId);
                        const newMessages = data.messages.filter(msg => !domIds.includes(String(msg.id)));

                        newMessages.forEach(msg => {
                            addMessageToChat(msg.username, msg.role, formatTime(msg.timestamp), msg.content, msg.pinned, msg.id);
                        });
                    }
                } catch (err) {
                    console.error("Auto-refresh error:", err);
                }
            }, 5000); // 5 seconds
        }

        // Hook into when a channel is switched
        function onChannelChange(channelName) {
            currentChannel = channelName;
            currentChannelDisplay.textContent = channelName;
            highlightCurrentChannel();
            loadMessagesForChannel();
            startChannelAutoRefresh(); // Start refreshing for the new channel
            
            // Hide new message notification when switching channels
            newMessageNotification.classList.add('hidden');
        }
        
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                const users = await response.json();
                userList.innerHTML = '';
                
                const onlineUsers = users.filter(user => user.online);
                onlineCount.textContent = onlineUsers.length;
                
                users.forEach(user => {
                    const userItem = document.createElement('li');
                    userItem.className = 'user-item mb-1';
                    
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex items-center py-1 px-2 rounded hover:bg-gray-800';
                    
                    const statusDot = document.createElement('div');
                    statusDot.className = `w-3 h-3 rounded-full mr-2 ${user.online ? 'bg-green-500' : 'bg-gray-500'}`;
                    
                    const usernameSpan = document.createElement('span');
                    const roleInfo = getRoleInfo(user.role);
                    usernameSpan.className = roleInfo.color;
                    usernameSpan.textContent = user.username;
                    
                    userDiv.appendChild(statusDot);
                    userDiv.appendChild(usernameSpan);
                    userItem.appendChild(userDiv);
                    userList.appendChild(userItem);
                });
                
                updateMembersSidebar(users);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        function updateMembersSidebar(users) {
            const onlineMembersList = document.getElementById('onlineMembersList');
            const offlineMembersList = document.getElementById('offlineMembersList');
            
            onlineMembersList.innerHTML = '';
            offlineMembersList.innerHTML = '';
            
            const onlineUsers = users.filter(user => user.online);
            const offlineUsers = users.filter(user => !user.online);
            
            document.getElementById('onlineCountSidebar').textContent = onlineUsers.length;
            document.getElementById('offlineCountSidebar').textContent = offlineUsers.length;
            
            onlineUsers.forEach(user => {
                const memberItem = document.createElement('li');
                memberItem.className = 'flex items-center py-1 px-2 rounded hover:bg-gray-800 cursor-pointer';
                const roleInfo = getRoleInfo(user.role);
                
                memberItem.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                    <span class="${roleInfo.color}">${user.username}</span>
                    ${user.role === 'admin' ? '<span class="ml-auto text-xs text-gray-500">Owner</span>' : ''}
                `;
                
                onlineMembersList.appendChild(memberItem);
            });
            
            offlineUsers.forEach(user => {
                const memberItem = document.createElement('li');
                memberItem.className = 'flex items-center py-1 px-2 rounded hover:bg-gray-800 cursor-pointer';
                const roleInfo = getRoleInfo(user.role);
                
                memberItem.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-gray-500 mr-2"></div>
                    <span class="${roleInfo.color}">${user.username}</span>
                `;
                
                offlineMembersList.appendChild(memberItem);
            });
        }
        
        async function loadMessagesForChannel() {
            try {
                channelOffset = 0;
                channelTotal = 0;
                messageList.innerHTML = '';
                loadingMore.classList.add('hidden');
                lastMessageId = null;
                
                // First get the total count
                const countResponse = await fetch(`${API_BASE}/messages?channel=${encodeURIComponent(currentChannel)}&offset=0&limit=1`, {
                    credentials: 'include'
                });
                
                if (!countResponse.ok) throw new Error('Failed to load messages');
                
                const countData = await countResponse.json();
                channelTotal = countData.total;
                
                // Then load the most recent messages
                const offset = Math.max(0, channelTotal - PAGE_SIZE);
                channelOffset = offset;
                
                const response = await fetch(`${API_BASE}/messages?channel=${encodeURIComponent(currentChannel)}&offset=${offset}&limit=${PAGE_SIZE}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load messages');
                
                const data = await response.json();
                
                if (data.messages.length === 0) {
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'message-enter mb-8 text-center';
                    welcomeDiv.innerHTML = `
                        <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4 border-2 border-green-600">
                            <i class="fas fa-code text-3xl text-green-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-green-400 mb-2">Welcome to ${currentChannel}!</h3>
                        <p class="text-gray-400">This is the start of the <span class="text-green-400">#${currentChannel}</span> channel.</p>
                    `;
                    messageList.appendChild(welcomeDiv);
                }
                
                data.messages.forEach(msg => {
                    addMessageToChat(msg.username, msg.role, formatTime(msg.timestamp), msg.content, msg.pinned, msg.id);
                    lastMessageId = msg.id;
                });
                
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        async function handleScroll() {
            if (channelLoading || channelOffset <= 0) return;
            
            if (messagesContainer.scrollTop < 100) {
                channelLoading = true;
                loadingMore.classList.remove('hidden');
                
                try {
                    const newOffset = Math.max(0, channelOffset - PAGE_SIZE);
                    const response = await fetch(`${API_BASE}/messages?channel=${encodeURIComponent(currentChannel)}&offset=${newOffset}&limit=${channelOffset - newOffset}`, {
                        credentials: 'include'
                    });
                    
                    if (!response.ok) throw new Error('Failed to load more messages');
                    
                    const data = await response.json();
                    const fragment = document.createDocumentFragment();
                    
                    data.messages.forEach(msg => {
                        const messageElement = createMessageElement(msg.username, msg.role, formatTime(msg.timestamp), msg.content, msg.pinned, msg.id);
                        fragment.insertBefore(messageElement, fragment.firstChild);
                    });
                    
                    messageList.insertBefore(fragment, messageList.firstChild);
                    channelOffset = newOffset;
                    
                    // Maintain scroll position after loading more messages
                    const firstMessage = messageList.firstElementChild;
                    if (firstMessage) {
                        const prevHeight = messagesContainer.scrollHeight;
                        const prevScroll = messagesContainer.scrollTop;
                        const newHeight = messagesContainer.scrollHeight;
                        messagesContainer.scrollTop = prevScroll + (newHeight - prevHeight);
                    }
                } catch (error) {
                    console.error('Error loading more messages:', error);
                } finally {
                    channelLoading = false;
                    loadingMore.classList.add('hidden');
                }
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function addMessageToChat(username, role, time, content, pinned, messageId) {
            const messageElement = createMessageElement(username, role, time, content, pinned, messageId);
            messageList.appendChild(messageElement);
            
            // Auto-scroll to bottom if we're near the bottom
            const isNearBottom = isScrollAtBottom();
            if (isNearBottom) {
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 50);
            }
        }
        
        function createMessageElement(username, role, time, content, pinned, messageId) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-enter mb-4 ${pinned ? 'pinned-message' : ''}`;
            messageDiv.dataset.messageId = messageId;
            
            const roleInfo = getRoleInfo(role);
            
            messageDiv.innerHTML = `
                <div class="flex items-start">
                    <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center mr-3 mt-1">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-baseline">
                            <span class="font-medium mr-2 ${roleInfo.color}">${username}</span>
                            <span class="text-xs text-gray-500">${time}</span>
                            ${pinned ? '<span class="ml-2 text-xs text-yellow-400"><i class="fas fa-thumbtack mr-1"></i>Pinned</span>' : ''}
                        </div>
                        <p class="text-gray-300 mt-1">${content}</p>
                        <div class="flex mt-1 space-x-3 text-xs text-gray-500">
                            <button class="hover:text-green-400 reply-btn" data-username="${username}" data-message-id="${messageId}">Reply</button>
                            ${currentUser.role === 'admin' || currentUser.role === 'moderator' ? 
                                `<button class="hover:text-green-400 pin-btn" data-message-id="${messageId}">${pinned ? 'Unpin' : 'Pin'}</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners to buttons
            const replyBtn = messageDiv.querySelector('.reply-btn');
            if (replyBtn) {
                replyBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    setupMessageReply(username, content, messageId);
                });
            }
            
            if (currentUser.role === 'admin' || currentUser.role === 'moderator') {
                const pinBtn = messageDiv.querySelector('.pin-btn');
                if (pinBtn) {
                    pinBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        togglePinMessage(messageId, !pinned);
                    });
                }
            }
            
            return messageDiv;
        }
        
        function setupMessageReply(username, content, messageId) {
            replyToMessage = messageId;
            replyToUser.textContent = username;
            replyPreview.textContent = content;
            replyIndicator.classList.remove('hidden');
            messageInput.focus();
        }
        
        function cancelMessageReply() {
            replyToMessage = null;
            replyIndicator.classList.add('hidden');
        }
        
        async function togglePinMessage(messageId, pinned) {
            try {
                const response = await fetch(`${API_BASE}/messages/pin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        channel: currentChannel,
                        messageId,
                        pinned
                    })
                });
                
                if (!response.ok) throw new Error('Failed to pin message');
                
                // Update the message display
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    if (pinned) {
                        messageElement.classList.add('pinned-message');
                        const pinBadge = messageElement.querySelector('.pin-btn');
                        if (pinBadge) pinBadge.textContent = 'Unpin';
                    } else {
                        messageElement.classList.remove('pinned-message');
                        const pinBadge = messageElement.querySelector('.pin-btn');
                        if (pinBadge) pinBadge.textContent = 'Pin';
                    }
                }
            } catch (error) {
                console.error('Error pinning message:', error);
            }
        }
        
        async function handleMessageInput(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                
                const content = messageInput.value.trim();
                if (!content) return;
                
                try {
                    const response = await fetch(`${API_BASE}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            channel: currentChannel,
                            content: replyToMessage ? `@${replyToUser.textContent} ${content}` : content,
                            replyTo: replyToMessage || undefined
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Failed to send message');
                    }
                    
                    const data = await response.json();
                    lastMessageId = data.id; // Update last message ID
                    
                    messageInput.value = '';
                    cancelMessageReply();
                    
                    // Immediately fetch and append the latest message from the server
                    try {
                        const latestResponse = await fetch(
                            `${API_BASE}/messages?channel=${encodeURIComponent(currentChannel)}&offset=${channelTotal}&limit=1`,
                            { credentials: 'include' }
                        );
                        if (latestResponse.ok) {
                            const latestData = await latestResponse.json();
                            if (latestData.messages.length > 0) {
                                const msg = latestData.messages[0];
                                addMessageToChat(msg.username, msg.role, formatTime(msg.timestamp), msg.content, msg.pinned, msg.id);
                                channelTotal++; // Keep count in sync
                            }
                        }
                    } catch (err) {
                        console.error("Error fetching latest message:", err);
                    }

                    // Show success message
                    const successElement = document.createElement('div');
                    successElement.className = 'text-green-400 mb-2 text-sm';
                    successElement.textContent = 'Message sent!';
                    messageInput.parentNode.insertBefore(successElement, messageInput);
                    
                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        if (successElement.parentNode) {
                            successElement.parentNode.removeChild(successElement);
                        }
                    }, 3000);
                } catch (error) {
                    console.error('Error sending message:', error);
                    // Show error to user
                    const errorElement = document.createElement('div');
                    errorElement.className = 'text-red-400 mb-2 text-sm';
                    errorElement.textContent = `Error: ${error.message}`;
                    messageInput.parentNode.insertBefore(errorElement, messageInput);
                    
                    // Remove error after 5 seconds
                    setTimeout(() => {
                        if (errorElement.parentNode) {
                            errorElement.parentNode.removeChild(errorElement);
                        }
                    }, 5000);
                }
            }
        }
        
        function toggleMembersSidebar() {
            membersSidebar.classList.toggle('hidden');
        }
        
        async function showPinnedMessages() {
            try {
                const response = await fetch(`${API_BASE}/messages/pinned?channel=${encodeURIComponent(currentChannel)}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load pinned messages');
                
                const pinnedMessages = await response.json();
                const pinnedList = document.getElementById('pinnedMessagesList');
                pinnedList.innerHTML = '';
                
                if (pinnedMessages.length === 0) {
                    pinnedList.innerHTML = '<p class="text-gray-400 text-center py-4">No pinned messages in this channel</p>';
                } else {
                    pinnedMessages.forEach(msg => {
                        const messageElement = createMessageElement(msg.username, msg.role, formatTime(msg.timestamp), msg.content, true, msg.id);
                        pinnedList.appendChild(messageElement);
                    });
                }
                
                pinnedMessagesModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading pinned messages:', error);
            }
        }
        
        function hidePinnedMessages() {
            pinnedMessagesModal.classList.add('hidden');
        }
        
        function showCreateChannelModal() {
            createChannelModal.classList.remove('hidden');
        }
        
        function hideCreateChannelModal() {
            createChannelModal.classList.add('hidden');
        }
        
        async function handleCreateChannel(e) {
            e.preventDefault();
            
            const name = document.getElementById('channelName').value.trim();
            const description = document.getElementById('channelDescription').value.trim();
            
            if (!name) {
                alert('Channel name is required');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/channels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        name,
                        description
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create channel');
                }
                
                hideCreateChannelModal();
                document.getElementById('channelName').value = '';
                document.getElementById('channelDescription').value = '';
                loadChannels();
            } catch (error) {
                alert(error.message);
            }
        }
    </script>
</body>
</html>
